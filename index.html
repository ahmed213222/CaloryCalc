<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„ØºØ°Ø§Ø¦ÙŠ Ø§Ù„Ø°ÙƒÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0ea5e9; /* sky-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .result-card, .comparison-card, .detailed-explanation, .alternative-card, .recipe-card {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .result-card-show, .comparison-card-show, .detailed-explanation-show, .alternative-card-show, .recipe-card-show {
            opacity: 1;
            transform: scale(1);
        }
        .detailed-explanation, .alternative-card {
            transition-delay: 200ms;
        }
        .prose ol, .prose ul { padding-right: 1.5rem; }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="container mx-auto p-4 md:p-8 min-h-screen flex flex-col items-center">
        
        <div class="w-full max-w-2xl text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-emerald-400 mb-2">
                Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„ØºØ°Ø§Ø¦ÙŠ Ø§Ù„Ø°ÙƒÙŠ
            </h1>
            <p class="text-gray-400 mb-8 text-lg">
                 Ø­Ù„Ù„ Ø·Ø¹Ø§Ù…Ù‹Ø§ØŒ Ù‚Ø§Ø±Ù† Ø¨Ù€ " - "ØŒ Ø£Ù†Ø´Ø¦ ÙˆØµÙØ© Ø¨Ù€ " + "ØŒ Ø£Ùˆ Ø§Ø·Ù„Ø¨ "Ø®Ø·Ø© ÙˆØ¬Ø¨Ø§Øª".
            </p>

            <!-- Input and Button -->
            <div class="flex flex-col sm:flex-row gap-2 mb-8">
                <input type="text" id="foodInput" class="flex-grow bg-gray-800 border border-gray-700 text-white rounded-lg p-4 focus:ring-2 focus:ring-sky-500 focus:outline-none placeholder-gray-500 text-right" placeholder="Ù…Ø«Ø§Ù„: ØªÙØ§Ø­ØŒ Ø£Ùˆ Ø®Ø·Ø© ÙˆØ¬Ø¨Ø§ØªØŒ Ø£Ùˆ Ø¯Ø¬Ø§Ø¬ + Ø£Ø±Ø²">
                <button id="analyzeButton" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-4 px-6 rounded-lg transition-colors duration-300 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-2"><path d="M20.4 14.5c-2.4-2.2-4.1-5.4-4.1-9.3V4a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v1.2c0 3.9-1.7 7.1-4.1 9.3-1 .9-1.6 2.3-1.6 3.8V21h18v-2.8c0-1.5-.6-2.9-1.6-3.7z"></path><path d="M9 21h6"></path><path d="M12 3v1"></path></svg>
                    Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†
                </button>
            </div>
        </div>

        <!-- Status and Result Area -->
        <div id="statusArea" class="text-center w-full max-w-2xl">
            <div id="loader" class="hidden loader mx-auto"></div>
            <div id="error" class="hidden text-red-400 bg-red-900/50 p-4 rounded-lg"></div>
            <div id="resultContainer" class="w-full space-y-6">
                <!-- Result will be injected here -->
            </div>
            <div id="initialMessage" class="text-gray-500 mt-12">
                <p>Ø³ØªØ¸Ù‡Ø± Ù†ØªØ§Ø¦Ø¬ ØªØ­Ù„ÙŠÙ„ Ø·Ø¹Ø§Ù…Ùƒ Ù‡Ù†Ø§.</p>
            </div>
        </div>

    </div>

    <script>
        // --- DOM Element References ---
        const foodInput = document.getElementById('foodInput');
        const analyzeButton = document.getElementById('analyzeButton');
        const loader = document.getElementById('loader');
        const errorContainer = document.getElementById('error');
        const resultContainer = document.getElementById('resultContainer');
        const initialMessage = document.getElementById('initialMessage');

        let lastAnalysisData = null;

        // --- Event Listeners ---
        analyzeButton.addEventListener('click', handleAnalysis);
        foodInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                handleAnalysis();
            }
        });

        /**
         * Main function to handle the analysis process.
         * It decides the flow based on user input.
         */
        async function handleAnalysis() {
            const foodQuery = foodInput.value.trim();
            if (!foodQuery) {
                showError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø·Ù„Ø¨ Ù„ØªØ­Ù„ÙŠÙ„Ù‡.");
                return;
            }
            resetUIState();

            const plusParts = foodQuery.split('+').map(p => p.trim()).filter(p => p);
            const dashParts = foodQuery.split('-').map(p => p.trim()).filter(p => p);

            if (foodQuery.startsWith("Ø®Ø·Ø© ÙˆØ¬Ø¨Ø§Øª")) {
                try {
                    const preferences = foodQuery.replace("Ø®Ø·Ø© ÙˆØ¬Ø¨Ø§Øª", "").trim();
                    const mealPlanData = await fetchMealPlan(preferences);
                    displayMealPlanResult(mealPlanData);
                } catch (err) {
                    handleApiError(err);
                }
            } else if (plusParts.length >= 2) {
                try {
                    const recipeData = await fetchRecipeSuggestion(plusParts);
                    displayRecipeResult(recipeData);
                } catch (err) {
                    handleApiError(err);
                }
            } else if (dashParts.length >= 2) {
                try {
                    const comparisonData = await fetchMultiFoodComparison(dashParts);
                    displayMultiComparisonResult(comparisonData);
                } catch (err) {
                    handleApiError(err);
                }
            } else {
                // --- Single Analysis Flow with Validation ---
                try {
                    const validation = await validateInputAsFood(foodQuery);
                    if (validation.is_food) {
                        const originalData = await fetchFoodAnalysis(foodQuery);
                        lastAnalysisData = originalData; 
                        const alternativeData = await fetchBetterAlternative(originalData);
                        displaySingleResult(originalData, alternativeData);
                    } else {
                        showError(`Ø§Ù„Ù…Ø¯Ø®Ù„ "${foodQuery}" ØºÙŠØ± Ù…ÙÙ‡ÙˆÙ… ÙƒØ·Ø¹Ø§Ù…. ${validation.reason}. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø·Ø¹Ø§Ù… Ù…Ø­Ø¯Ø¯ØŒ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©.`);
                    }
                } catch (err) {
                    handleApiError(err);
                }
            }
            hideLoader();
        }
        
        /**
         * Generic function to call the Gemini API with retry logic.
         */
        async function callGemini(prompt, responseSchema = null) {
            const apiKey = "AIzaSyC8YmKYw6-Z-DxHTU8tv6V9fhhOa0pDqdU";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            if (responseSchema) {
                payload.generationConfig = { responseMimeType: "application/json", responseSchema: responseSchema };
            }

            const maxRetries = 4;
            let delay = 2000;
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (response.ok) {
                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                        const text = result.candidates[0].content.parts[0].text;
                        return responseSchema ? JSON.parse(text) : text;
                    } else { throw new Error("Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ù…Ù† ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ù€ API."); }
                }
                if (response.status === 503 && attempt < maxRetries) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                } else {
                    const errorBody = await response.text();
                    throw new Error(`ÙØ´Ù„ Ø·Ù„Ø¨ Ø§Ù„Ù€ API Ø¨Ø§Ù„Ø­Ø§Ù„Ø© ${response.status}: ${errorBody}`);
                }
            }
        }

        async function validateInputAsFood(query) {
            const responseSchema = {
                type: "OBJECT",
                properties: {
                    is_food: { type: "BOOLEAN" },
                    reason: { type: "STRING" }
                },
                required: ["is_food", "reason"]
            };
            const prompt = `Ø­Ù„Ù„ Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ: "${query}". Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ ÙŠÙ…Ø«Ù„ Ø§Ø³Ù…Ù‹Ø§ Ù„Ø·Ø¹Ø§Ù… Ø£Ùˆ Ø´Ø±Ø§Ø¨ Ù…Ø­Ø¯Ø¯ ÙˆÙ‚Ø§Ø¨Ù„ Ù„Ù„Ø£ÙƒÙ„ (Ù…Ø«Ù„ "ØªÙØ§Ø­Ø©" Ø£Ùˆ "ØµØ¯Ø± Ø¯Ø¬Ø§Ø¬ Ù…Ø´ÙˆÙŠ") ÙˆÙ„ÙŠØ³ ÙØ¦Ø© Ø¹Ø§Ù…Ø© Ø£Ùˆ Ø£Ù…Ø±Ù‹Ø§ Ø£Ùˆ Ø¬Ù…Ù„Ø© ØºÙŠØ± Ù…Ù†Ø·Ù‚ÙŠØ©ØŸ Ø£Ø¬Ø¨ Ø¨ØµÙŠØºØ© JSON Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.`;
            return await callGemini(prompt, responseSchema);
        }

        async function fetchFoodAnalysis(foodName) {
            const responseSchema = { type: "OBJECT", properties: { foodName: { type: "STRING" }, calories: { type: "NUMBER" }, fat: { type: "NUMBER" }, protein: { type: "NUMBER" }, carbohydrates: { type: "NUMBER" }, isFastingFriendly: { type: "BOOLEAN" }, reasoning: { type: "STRING" } }, required: ["foodName", "calories", "fat", "protein", "carbohydrates", "isFastingFriendly", "reasoning"] };
            const prompt = `Ø£Ù†Øª Ø®Ø¨ÙŠØ± ØªØºØ°ÙŠØ©. Ø­Ù„Ù„ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„ØºØ°Ø§Ø¦ÙŠ: "${foodName}". Ø­Ø¯Ø¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠÙƒØ³Ø± Ø§Ù„ØµÙŠØ§Ù… (Ø£ÙƒØ«Ø± Ù…Ù† 10 Ø³Ø¹Ø±Ø§Øª). Ù‚Ø¯Ù… Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©: foodName, calories, fat, protein, carbohydrates, isFastingFriendly, reasoning. Ø£Ø±Ø¬Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ€ JSON.`;
            return await callGemini(prompt, responseSchema);
        }

        async function fetchBetterAlternative(originalFood) {
            const responseSchema = { type: "OBJECT", properties: { alternativeName: { type: "STRING" }, reason: { type: "STRING" }, calories: { type: "NUMBER" } }, required: ["alternativeName", "reason", "calories"] };
            const prompt = `Ø£Ù†Øª Ø®Ø¨ÙŠØ± ØªØºØ°ÙŠØ©. Ø§Ù„Ø·Ø¹Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ "${originalFood.foodName}" ÙˆØ¨Ù‡ Ø­ÙˆØ§Ù„ÙŠ ${originalFood.calories} Ø³Ø¹Ø±Ø© Ø­Ø±Ø§Ø±ÙŠØ©. Ø§Ù‚ØªØ±Ø­ Ø¨Ø¯ÙŠÙ„Ø§Ù‹ ØµØ­ÙŠØ§Ù‹ Ø£ÙØ¶Ù„. Ù‚Ø¯Ù… Ø§Ø³Ù… Ø§Ù„Ø¨Ø¯ÙŠÙ„ØŒ Ø³Ø¨Ø¨ ÙƒÙˆÙ†Ù‡ Ø£ÙØ¶Ù„ØŒ ÙˆØ¹Ø¯Ø¯ Ø³Ø¹Ø±Ø§ØªÙ‡ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©. Ø£Ø±Ø¬Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ØµÙŠØºØ© JSON Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.`;
            try {
                return await callGemini(prompt, responseSchema);
            } catch (error) {
                console.error("Could not fetch alternative:", error);
                return null;
            }
        }

        async function fetchMultiFoodComparison(foods) {
            const responseSchema = { type: "OBJECT", properties: { comparisonResults: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, calories: { type: "NUMBER" }, fat: { type: "NUMBER" }, protein: { type: "NUMBER" }, carbs: { type: "NUMBER" } }, required: ["name", "calories", "fat", "protein", "carbs"] } }, verdict: { type: "STRING" } }, required: ["comparisonResults", "verdict"] };
            const foodList = foods.join('ØŒ ');
            const prompt = `Ø£Ù†Øª Ø®Ø¨ÙŠØ± ØªØºØ°ÙŠØ©. Ù‚Ø§Ø±Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø·Ø¹Ù…Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©: ${foodList}. Ù‚Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙŠ ØµÙŠØºØ© JSON Ø­Ø³Ø¨ Ø§Ù„Ù€ schema. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (verdict) Ø¹Ù„Ù‰ Ù…Ù„Ø®Øµ Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø© ÙˆØªÙˆØµÙŠØ© ÙˆØ§Ø¶Ø­Ø©.`;
            return await callGemini(prompt, responseSchema);
        }
        
        async function fetchMealPlan(preferences) {
            const responseSchema = { type: "OBJECT", properties: { planTitle: { type: "STRING" }, dailyCalories: { type: "STRING" }, meals: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, time: { type: "STRING" }, items: { type: "ARRAY", items: { type: "STRING" } } }, required: ["name", "time", "items"] } } }, required: ["planTitle", "dailyCalories", "meals"] };
            const prompt = `Ø£Ù†Øª Ø®Ø¨ÙŠØ± ØªØºØ°ÙŠØ©. ØµÙ…Ù… Ø®Ø·Ø© ÙˆØ¬Ø¨Ø§Øª Ù„ÙŠÙˆÙ… ÙƒØ§Ù…Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªÙØ¶ÙŠÙ„ Ø§Ù„ØªØ§Ù„ÙŠ: '${preferences || 'ØµØ­Ø© Ø¹Ø§Ù…Ø©'}'. Ù‚Ø¯Ù… Ø¹Ù†ÙˆØ§Ù†Ù‹Ø§ Ù„Ù„Ø®Ø·Ø©ØŒ ØªÙ‚Ø¯ÙŠØ±Ù‹Ø§ Ù„Ù„Ø³Ø¹Ø±Ø§ØªØŒ Ùˆ3 ÙˆØ¬Ø¨Ø§Øª Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆÙˆØ¬Ø¨Ø© Ø®ÙÙŠÙØ© Ù…Ø¹ Ù…ÙƒÙˆÙ†Ø§ØªÙ‡Ø§. Ø£Ø±Ø¬Ø¹ ÙƒÙ„ Ù‡Ø°Ø§ Ø¨ØªÙ†Ø³ÙŠÙ‚ JSON Ø¯Ù‚ÙŠÙ‚ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.`;
            return await callGemini(prompt, responseSchema);
        }

        async function fetchRecipeSuggestion(ingredients) {
            const responseSchema = { type: "OBJECT", properties: { recipeName: { type: "STRING" }, description: { type: "STRING" }, healthAdvice: { type: "STRING" }, instructions: { type: "ARRAY", items: { type: "STRING" } }, nutrition: { type: "OBJECT", properties: { calories: { type: "STRING" }, protein: { type: "STRING" } } }, youtubeSearchQuery: { type: "STRING" } }, required: ["recipeName", "description", "healthAdvice", "instructions", "nutrition", "youtubeSearchQuery"] };
            const ingredientList = ingredients.join('ØŒ ');
            const prompt = `Ø£Ù†Øª Ø´ÙŠÙ ÙˆØ®Ø¨ÙŠØ± ØªØºØ°ÙŠØ©. Ø£Ø¹Ø·ÙŠØªÙƒ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©: ${ingredientList}. Ø§Ù‚ØªØ±Ø­ Ø§Ø³Ù…Ù‹Ø§ Ø¬Ø°Ø§Ø¨Ù‹Ø§ØŒ ÙˆØµÙÙ‹Ø§ØŒ Ù†ØµÙŠØ­Ø© ØµØ­ÙŠØ© (Ù…Ø¹ Ø¨Ø¯Ø§Ø¦Ù„ Ù„Ùˆ Ù„Ø²Ù…)ØŒ Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ­Ø¶ÙŠØ±ØŒ ØªÙ‚Ø¯ÙŠØ± Ù„Ù„Ø³Ø¹Ø±Ø§Øª ÙˆØ§Ù„Ø¨Ø±ÙˆØªÙŠÙ†ØŒ ÙˆØ¹Ø¨Ø§Ø±Ø© Ø¨Ø­Ø« Ù„ÙŠÙˆØªÙŠÙˆØ¨. Ø£Ø±Ø¬Ø¹ ÙƒÙ„ Ù‡Ø°Ø§ Ø¨ØªÙ†Ø³ÙŠÙ‚ JSON Ø¯Ù‚ÙŠÙ‚ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.`;
            return await callGemini(prompt, responseSchema);
        }

        function displaySingleResult(originalData, alternativeData) {
            const card = document.createElement('div');
            card.className = 'result-card result-card-show bg-gray-800 border border-gray-700 rounded-xl p-6 text-right w-full';
            const isFriendly = originalData.isFastingFriendly;
            const statusLabel = isFriendly ? 'Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„ØµÙŠØ§Ù…' : 'ÙŠÙƒØ³Ø± Ø§Ù„ØµÙŠØ§Ù…';
            card.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-white">${originalData.foodName}</h2>
                    <span class="flex items-center text-sm font-bold px-3 py-1.5 rounded-full ${isFriendly ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'}">
                        <span class="w-2 h-2 ml-2 rounded-full ${isFriendly ? 'bg-green-400' : 'bg-red-400'}"></span>
                        ${statusLabel}
                    </span>
                </div>
                <p class="text-gray-400 mb-6 italic">"${originalData.reasoning}"</p>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                    <div class="bg-gray-700/50 p-4 rounded-lg"><p class="text-sm text-gray-400 mb-1">Ø§Ù„Ø³Ø¹Ø±Ø§Øª</p><p class="text-2xl font-semibold text-sky-300">${(originalData.calories ?? 0).toFixed(0)}</p></div>
                    <div class="bg-gray-700/50 p-4 rounded-lg"><p class="text-sm text-gray-400 mb-1">Ø§Ù„Ø¯Ù‡ÙˆÙ†</p><p class="text-2xl font-semibold text-sky-300">${(originalData.fat ?? 0).toFixed(1)} Ø¬</p></div>
                    <div class="bg-gray-700/50 p-4 rounded-lg"><p class="text-sm text-gray-400 mb-1">Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†</p><p class="text-2xl font-semibold text-sky-300">${(originalData.protein ?? 0).toFixed(1)} Ø¬</p></div>
                    <div class="bg-gray-700/50 p-4 rounded-lg"><p class="text-sm text-gray-400 mb-1">Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª</p><p class="text-2xl font-semibold text-sky-300">${(originalData.carbohydrates ?? 0).toFixed(1)} Ø¬</p></div>
                </div>
            `;
            resultContainer.appendChild(card);

            if (alternativeData) {
                const alternativeCard = document.createElement('div');
                alternativeCard.className = 'alternative-card alternative-card-show bg-teal-900/50 border border-teal-700 rounded-xl p-6 text-right w-full';
                alternativeCard.innerHTML = `
                    <h3 class="text-xl font-bold text-white mb-3 text-center">ğŸ’¡ Ø¨Ø¯ÙŠÙ„ Ø£ÙØ¶Ù„ Ù…Ù‚ØªØ±Ø­</h3>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-emerald-300">${alternativeData.alternativeName}</p>
                        <p class="text-lg text-gray-300 mb-4">(~${(alternativeData.calories ?? 0).toFixed(0)} Ø³Ø¹Ø±Ø© Ø­Ø±Ø§Ø±ÙŠØ©)</p>
                        <p class="text-gray-300 leading-relaxed">${alternativeData.reason}</p>
                    </div>
                `;
                resultContainer.appendChild(alternativeCard);
            }

            const explanationCard = document.createElement('div');
            explanationCard.className = 'detailed-explanation detailed-explanation-show bg-gray-800 border-dashed border-2 border-gray-700 rounded-xl p-6 text-right w-full';
            explanationCard.innerHTML = `<button id="explanationBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg">Ø§Ø·Ù„Ø¨ Ø´Ø±Ø­Ù‹Ø§ ØªÙØµÙŠÙ„ÙŠÙ‹Ø§ Ø¹Ù† ${originalData.foodName}</button><div id="explanationLoader" class="hidden loader mx-auto mt-4"></div><div id="explanationResult" class="text-gray-300 mt-4 prose prose-invert max-w-none text-right"></div>`;
            resultContainer.appendChild(explanationCard);
            document.getElementById('explanationBtn').addEventListener('click', handleDetailedExplanation);
        }

        function displayMultiComparisonResult(data) {
            if (!data || !data.comparisonResults || data.comparisonResults.length === 0) {
                showError("Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©.");
                return;
            }
            const card = document.createElement('div');
            card.className = 'comparison-card comparison-card-show bg-gray-800 border border-gray-700 rounded-xl p-6 text-right w-full';
            const foodNames = data.comparisonResults.map(item => item.name).join(' Ùˆ ');
            let gridColsClass = '';
            switch(data.comparisonResults.length) {
                case 2: gridColsClass = 'grid-cols-2'; break;
                case 3: gridColsClass = 'grid-cols-1 md:grid-cols-3'; break;
                default: gridColsClass = 'grid-cols-2 md:grid-cols-4'; break;
            }
            let columnsHTML = '';
            const colors = ['sky', 'emerald', 'amber', 'rose', 'indigo'];
            data.comparisonResults.forEach((item, index) => {
                const color = colors[index % colors.length];
                columnsHTML += `
                    <div class="border-l border-gray-700 pl-4 last:border-l-0">
                        <h3 class="text-xl font-bold text-${color}-300 mb-3">${item.name}</h3>
                        <p class="mb-2"><span class="font-semibold">Ø§Ù„Ø³Ø¹Ø±Ø§Øª:</span> ${(item.calories ?? 0).toFixed(0)}</p>
                        <p class="mb-2"><span class="font-semibold">Ø§Ù„Ø¯Ù‡ÙˆÙ†:</span> ${(item.fat ?? 0).toFixed(1)} Ø¬</p>
                        <p class="mb-2"><span class="font-semibold">Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†:</span> ${(item.protein ?? 0).toFixed(1)} Ø¬</p>
                        <p class="mb-2"><span class="font-semibold">Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª:</span> ${(item.carbs ?? 0).toFixed(1)} Ø¬</p>
                    </div>
                `;
            });
            card.innerHTML = `
                <h2 class="text-2xl font-bold text-white text-center mb-6">Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙŠÙ†: ${foodNames}</h2>
                <div class="grid ${gridColsClass} gap-4">${columnsHTML}</div>
                <hr class="border-gray-700 my-6">
                <div>
                    <h3 class="text-xl font-bold text-white mb-3 text-center">Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h3>
                    <p class="text-gray-300 leading-relaxed">${data.verdict}</p>
                </div>
            `;
            resultContainer.appendChild(card);
        }
        
        function displayMealPlanResult(data) {
            const card = document.createElement('div');
            card.className = 'recipe-card recipe-card-show bg-gray-800 border border-gray-700 rounded-xl p-6 text-right w-full prose prose-invert max-w-none';

            let mealsHTML = '';
            data.meals.forEach(meal => {
                const itemsHTML = meal.items.map(item => `<li>${item}</li>`).join('');
                mealsHTML += `
                    <div class="bg-gray-700/50 p-4 rounded-lg mb-4">
                        <h4 class="text-lg font-bold text-emerald-300">${meal.name} <span class="text-sm text-gray-400">(${meal.time})</span></h4>
                        <ul class="list-disc list-inside space-y-1 mt-2">
                            ${itemsHTML}
                        </ul>
                    </div>
                `;
            });

            card.innerHTML = `
                <h2 class="text-3xl font-bold text-center text-emerald-300 mb-2">${data.planTitle}</h2>
                <p class="text-center text-gray-400 italic mb-6">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ù…Ù‚Ø¯Ø±Ø©: ${data.dailyCalories}</p>
                
                ${mealsHTML}
            `;
            resultContainer.appendChild(card);
        }

        function displayRecipeResult(data) {
            const card = document.createElement('div');
            card.className = 'recipe-card recipe-card-show bg-gray-800 border border-gray-700 rounded-xl p-6 text-right w-full prose prose-invert max-w-none';
            
            const instructionsHTML = data.instructions.map(step => `<li>${step}</li>`).join('');
            const youtubeLink = `https://www.youtube.com/results?search_query=${encodeURIComponent(data.youtubeSearchQuery)}`;

            card.innerHTML = `
                <h2 class="text-3xl font-bold text-center text-emerald-300 mb-2">${data.recipeName}</h2>
                <p class="text-center text-gray-400 italic mb-6">${data.description}</p>
                
                <div class="bg-yellow-900/50 border border-yellow-700 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-bold text-yellow-300">â­ Ù†ØµÙŠØ­Ø© ØµØ­ÙŠØ©</h3>
                    <p class="text-yellow-200">${data.healthAdvice}</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center mb-6">
                    <div class="bg-gray-700/50 p-3 rounded-lg">
                        <p class="text-sm text-gray-400">Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©</p>
                        <p class="text-xl font-semibold text-sky-300">${data.nutrition.calories}</p>
                    </div>
                    <div class="bg-gray-700/50 p-3 rounded-lg">
                        <p class="text-sm text-gray-400">Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ† Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ</p>
                        <p class="text-xl font-semibold text-sky-300">${data.nutrition.protein}</p>
                    </div>
                </div>

                <h3 class="text-xl font-bold mb-3">ğŸ“‹ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØªØ­Ø¶ÙŠØ±</h3>
                <ol class="list-decimal list-inside space-y-2 mb-6">${instructionsHTML}</ol>

                <a href="${youtubeLink}" target="_blank" rel="noopener noreferrer" class="mt-4 inline-block w-full text-center bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 no-underline">
                    <svg xmlns="http://www.w3.org/2000/svg" class="inline-block ml-2 h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M10,15L15.19,12L10,9V15M21.56,7.17C21.69,7.64 21.78,8.27 21.84,9.07C21.91,9.87 21.94,10.56 21.94,11.16L22,12C22,14.19 21.84,15.8 21.56,16.83C21.31,17.73 20.73,18.31 19.83,18.56C19.36,18.69 18.73,18.78 17.93,18.84C17.13,18.91 16.44,18.94 15.84,18.94L15,19C12.81,19 11.2,18.84 10.17,18.56C9.27,18.31 8.69,17.73 8.44,16.83C8.31,16.36 8.22,15.73 8.16,14.93C8.09,14.13 8.06,13.44 8.06,12.84L8,12C8,9.81 8.16,8.2 8.44,7.17C8.69,6.27 9.27,5.69 10.17,5.44C11.2,5.16 12.81,5 15,5L15.84,5.06C16.44,5.06 17.13,5.09 17.93,5.16C18.73,5.22 19.36,5.31 19.83,5.44C20.73,5.69 21.31,6.27 21.56,7.17Z"></path></svg>
                    Ø´Ø§Ù‡Ø¯ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ­Ø¶ÙŠØ± Ø¹Ù„Ù‰ ÙŠÙˆØªÙŠÙˆØ¨
                </a>
            `;
            resultContainer.appendChild(card);
        }

        async function handleDetailedExplanation() {
            const btn = document.getElementById('explanationBtn');
            const loader = document.getElementById('explanationLoader');
            const resultDiv = document.getElementById('explanationResult');
            btn.disabled = true;
            btn.classList.add('opacity-50');
            loader.classList.remove('hidden');
            resultDiv.innerHTML = '';
            try {
                const prompt = `Ø¨ØµÙØªÙƒ Ø®Ø¨ÙŠØ± ØªØºØ°ÙŠØ©ØŒ Ù‚Ø¯Ù… Ø´Ø±Ø­Ù‹Ø§ ØªÙØµÙŠÙ„ÙŠÙ‹Ø§ ÙˆÙ…ÙØµÙ„Ø§Ù‹ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¹Ù† "${lastAnalysisData.foodName}". ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ¶Ù…Ù† Ø§Ù„Ø´Ø±Ø­: Ø§Ù„ÙÙˆØ§Ø¦Ø¯ Ø§Ù„ØµØ­ÙŠØ©ØŒ Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© (ÙƒÙŠØªÙˆØŒ Ù†Ø¨Ø§ØªÙŠ)ØŒ Ù†ØµØ§Ø¦Ø­ Ù„Ù„ØªÙ†Ø§ÙˆÙ„ØŒ ÙˆÙ…Ø­Ø§Ø°ÙŠØ± (Ø¥Ù† ÙˆØ¬Ø¯Øª).`;
                const explanation = await callGemini(prompt);
                resultDiv.innerHTML = explanation.replace(/\n/g, '<br>');
            } catch (err) {
                handleApiError(err, resultDiv);
            } finally {
                loader.classList.add('hidden');
                btn.style.display = 'none';
            }
        }

        // --- UI State and Error Helper Functions ---
        function resetUIState() {
            hideError();
            resultContainer.innerHTML = '';
            initialMessage.classList.add('hidden');
            showLoader();
            analyzeButton.disabled = true;
            analyzeButton.classList.add('opacity-50', 'cursor-not-allowed');
        }
        function showLoader() { loader.classList.remove('hidden'); }
        function hideLoader() { 
            loader.classList.add('hidden');
            analyzeButton.disabled = false;
            analyzeButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        function showError(message) {
            errorContainer.textContent = message;
            errorContainer.classList.remove('hidden');
        }
        function hideError() { errorContainer.classList.add('hidden'); }
        function handleApiError(err, element = errorContainer) {
            console.error("An error occurred:", err);
            const message = (err.message && (err.message.includes("status 503") || err.message.includes("The model is overloaded")))
                ? "Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ø´ØºÙˆÙ„Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø­Ø¸Ø© Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©."
                : "Ø¹Ø°Ø±Ù‹Ø§ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
            if (element === errorContainer) { showError(message); } 
            else { element.innerHTML = `<p class="text-red-400">${message}</p>`; }
        }
    </script>
</body>
</html>
